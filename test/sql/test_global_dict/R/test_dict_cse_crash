-- name: test_dict_cse_crash
SET cbo_enable_low_cardinality_optimize = true;
-- result:
-- !result
CREATE TABLE t1 (
    id INT,
    str_col VARCHAR(100) NOT NULL,
    arr1 ARRAY<VARCHAR(10)>,
    arr2 ARRAY<VARCHAR(10)>
) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
CREATE TABLE t2 (id INT) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO t1 VALUES (1, 'aaa', ['x','y'], ['a','b']), (2, 'bbb', ['x','y'], ['c','d']);
-- result:
-- !result
INSERT INTO t2 VALUES (1), (2);
-- result:
-- !result
SELECT SLEEP(3);
-- result:
1
-- !result
[UC] ANALYZE FULL TABLE t1;
-- result:
test_db_d85685ced1754d63b9f461890a908100.t1	analyze	status	OK
-- !result
function: wait_global_dict_ready('str_col', 't1')
-- result:

-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> concat(x, upper(str_col)), arr1) FROM t1;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 110.0
  Memory: 0.0

PLAN FRAGMENT 0(F00)
  Fragment Cost: 55.0
  Output Exprs:1: id | 9: array_map
  Input Partition: RANDOM
  RESULT SINK

  1:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  9 <-> array_map[([8, VARCHAR(10), true] -> concat[([8, VARCHAR(10), true], [11: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], [3: arr1, ARRAY<VARCHAR(10)>, true]); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  common expressions:
  |  11 <-> DictDecode([10: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  cardinality: 2
  |  
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     dict_col=str_col
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=40.0
     Pruned type: 3 <-> [ARRAY<VARCHAR(10)>]
     cardinality: 2
-- !result
[UC]SELECT id, array_map(x -> concat(x, upper(str_col)), arr1) FROM t1 ORDER BY id;
-- result:
1	["xAAA","yAAA"]
2	["xBBB","yBBB"]
-- !result
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> concat(x, upper(l.str_col)), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 298.0
  Memory: 8.0

PLAN FRAGMENT 0(F03)
  Fragment Cost: 0.0
  Output Exprs:1: id | 13: array_map
  Input Partition: UNPARTITIONED
  RESULT SINK

  5:EXCHANGE
     cardinality: 2

PLAN FRAGMENT 1(F00)
  Fragment Cost: 161.25

  Input Partition: RANDOM
  OutPut Partition: UNPARTITIONED
  OutPut Exchange Id: 05

  4:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  13 <-> array_map[([12, VARCHAR(10), true] -> concat[([12, VARCHAR(10), true], [16: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], DictDecode([15: arr1, ARRAY<INT>, true], [<place-holder>])); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  common expressions:
  |  16 <-> DictDecode([14: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  cardinality: 2
  |  
  3:HASH JOIN
  |  join op: INNER JOIN (BUCKET_SHUFFLE)
  |  equal join conjunct: [1: id, INT, true] = [8: id, INT, true]
  |  build runtime filters:
  |  - filter_id = 0, build_expr = (8: id), remote = false
  |  output columns: 1, 14, 15
  |  can local shuffle: false
  |  cardinality: 2
  |  
  |----2:EXCHANGE
  |       distribution type: SHUFFLE
  |       partition exprs: [8: id, INT, true]
  |       cardinality: 2
  |    
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     Predicates: [1: id, INT, true] IS NOT NULL
     dict_col=str_col,arr1
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=39.0
     Pruned type: 15 <-> [ARRAY<INT>]
     cardinality: 2
     probe runtime filters:
     - filter_id = 0, probe_expr = (1: id)

PLAN FRAGMENT 2(F01)
  Fragment Cost: 4.0

  Input Partition: RANDOM
  OutPut Partition: BUCKET_SHUFFLE_HASH_PARTITIONED: 8: id
  OutPut Exchange Id: 02

  1:OlapScanNode
     table: t2, rollup: t2
     preAggregation: on
     Predicates: [8: id, INT, true] IS NOT NULL
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13942
     actualRows=0, avgRowSize=4.0
     cardinality: 2
-- !result
[UC]SELECT l.id, array_map(x -> concat(x, upper(l.str_col)), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;
-- result:
1	["xAAA","yAAA"]
2	["xBBB","yBBB"]
-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> concat(y, upper(str_col)), arr2), arr1) FROM t1;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 174.0
  Memory: 0.0

PLAN FRAGMENT 0(F00)
  Fragment Cost: 87.0
  Output Exprs:1: id | 10: array_map
  Input Partition: RANDOM
  RESULT SINK

  1:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  10 <-> array_map[([8, VARCHAR(10), true] -> [13: array_map, ARRAY<VARCHAR>, true], [3: arr1, ARRAY<VARCHAR(10)>, true]); args: FUNCTION,INVALID_TYPE; result: ARRAY<ARRAY<VARCHAR>>; args nullable: true; result nullable: true]
  |  common expressions:
  |  12 <-> DictDecode([11: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  13 <-> array_map[([9, VARCHAR(10), true] -> concat[([9, VARCHAR(10), true], [12: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], [4: arr2, ARRAY<VARCHAR(10)>, true]); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  cardinality: 2
  |  
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     dict_col=str_col
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=72.0
     Pruned type: 3 <-> [ARRAY<VARCHAR(10)>]
     Pruned type: 4 <-> [ARRAY<VARCHAR(10)>]
     cardinality: 2
-- !result
[UC]SELECT id, array_map(x -> array_map(y -> concat(y, upper(str_col)), arr2), arr1) FROM t1 ORDER BY id;
-- result:
1	[["aAAA","bAAA"],["aAAA","bAAA"]]
2	[["cBBB","dBBB"],["cBBB","dBBB"]]
-- !result
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(l.str_col)), l.arr2), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 490.0
  Memory: 8.0

PLAN FRAGMENT 0(F03)
  Fragment Cost: 0.0
  Output Exprs:1: id | 14: array_map
  Input Partition: UNPARTITIONED
  RESULT SINK

  5:EXCHANGE
     cardinality: 2

PLAN FRAGMENT 1(F00)
  Fragment Cost: 257.25

  Input Partition: RANDOM
  OutPut Partition: UNPARTITIONED
  OutPut Exchange Id: 05

  4:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  14 <-> array_map[([12, VARCHAR(10), true] -> [20: array_map, ARRAY<VARCHAR>, true], DictDecode([16: arr1, ARRAY<INT>, true], [<place-holder>])); args: FUNCTION,INVALID_TYPE; result: ARRAY<ARRAY<VARCHAR>>; args nullable: true; result nullable: true]
  |  common expressions:
  |  18 <-> DictDecode([15: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  19 <-> DictDecode([17: arr2, ARRAY<INT>, true], [<place-holder>])
  |  20 <-> array_map[([13, VARCHAR(10), true] -> concat[([13, VARCHAR(10), true], [18: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], [19: expr, ARRAY<VARCHAR(10)>, true]); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  cardinality: 2
  |  
  3:HASH JOIN
  |  join op: INNER JOIN (BUCKET_SHUFFLE)
  |  equal join conjunct: [1: id, INT, true] = [8: id, INT, true]
  |  build runtime filters:
  |  - filter_id = 0, build_expr = (8: id), remote = false
  |  output columns: 1, 15, 16, 17
  |  can local shuffle: false
  |  cardinality: 2
  |  
  |----2:EXCHANGE
  |       distribution type: SHUFFLE
  |       partition exprs: [8: id, INT, true]
  |       cardinality: 2
  |    
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     Predicates: [1: id, INT, true] IS NOT NULL
     dict_col=arr2,str_col,arr1
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=71.0
     Pruned type: 17 <-> [ARRAY<INT>]
     Pruned type: 16 <-> [ARRAY<INT>]
     cardinality: 2
     probe runtime filters:
     - filter_id = 0, probe_expr = (1: id)

PLAN FRAGMENT 2(F01)
  Fragment Cost: 4.0

  Input Partition: RANDOM
  OutPut Partition: BUCKET_SHUFFLE_HASH_PARTITIONED: 8: id
  OutPut Exchange Id: 02

  1:OlapScanNode
     table: t2, rollup: t2
     preAggregation: on
     Predicates: [8: id, INT, true] IS NOT NULL
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13942
     actualRows=0, avgRowSize=4.0
     cardinality: 2
-- !result
[UC]SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(l.str_col)), l.arr2), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;
-- result:
1	[["aAAA","bAAA"],["aAAA","bAAA"]]
2	[["cBBB","dBBB"],["cBBB","dBBB"]]
-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> concat(x, upper(str_col), lower(str_col)), arr1) FROM t1;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 110.0
  Memory: 0.0

PLAN FRAGMENT 0(F00)
  Fragment Cost: 55.0
  Output Exprs:1: id | 9: array_map
  Input Partition: RANDOM
  RESULT SINK

  1:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  9 <-> array_map[([8, VARCHAR(10), true] -> concat[([8, VARCHAR(10), true], [11: expr, VARCHAR, true], [12: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], [3: arr1, ARRAY<VARCHAR(10)>, true]); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  common expressions:
  |  11 <-> DictDecode([10: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  12 <-> DictDecode([10: str_col, INT, false], [lower[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  cardinality: 2
  |  
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     dict_col=str_col
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=40.0
     Pruned type: 3 <-> [ARRAY<VARCHAR(10)>]
     cardinality: 2
-- !result
[UC]SELECT id, array_map(x -> concat(x, upper(str_col), lower(str_col)), arr1) FROM t1 ORDER BY id;
-- result:
1	["xAAAaaa","yAAAaaa"]
2	["xBBBbbb","yBBBbbb"]
-- !result
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> concat(x, upper(l.str_col), lower(l.str_col)), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id;
-- result:
RESOURCE GROUP: default_wg

PLAN COST
  CPU: 298.0
  Memory: 8.0

PLAN FRAGMENT 0(F03)
  Fragment Cost: 0.0
  Output Exprs:1: id | 13: array_map
  Input Partition: UNPARTITIONED
  RESULT SINK

  5:EXCHANGE
     cardinality: 2

PLAN FRAGMENT 1(F00)
  Fragment Cost: 161.25

  Input Partition: RANDOM
  OutPut Partition: UNPARTITIONED
  OutPut Exchange Id: 05

  4:Project
  |  output columns:
  |  1 <-> [1: id, INT, true]
  |  13 <-> array_map[([12, VARCHAR(10), true] -> concat[([12, VARCHAR(10), true], [16: expr, VARCHAR, true], [17: expr, VARCHAR, true]); args: VARCHAR; result: VARCHAR; args nullable: true; result nullable: true], DictDecode([15: arr1, ARRAY<INT>, true], [<place-holder>])); args: FUNCTION,INVALID_TYPE; result: ARRAY<VARCHAR>; args nullable: true; result nullable: true]
  |  common expressions:
  |  16 <-> DictDecode([14: str_col, INT, false], [upper[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  17 <-> DictDecode([14: str_col, INT, false], [lower[(<place-holder>); args: VARCHAR; result: VARCHAR; args nullable: false; result nullable: true]])
  |  cardinality: 2
  |  
  3:HASH JOIN
  |  join op: INNER JOIN (BUCKET_SHUFFLE)
  |  equal join conjunct: [1: id, INT, true] = [8: id, INT, true]
  |  build runtime filters:
  |  - filter_id = 0, build_expr = (8: id), remote = false
  |  output columns: 1, 14, 15
  |  can local shuffle: false
  |  cardinality: 2
  |  
  |----2:EXCHANGE
  |       distribution type: SHUFFLE
  |       partition exprs: [8: id, INT, true]
  |       cardinality: 2
  |    
  0:OlapScanNode
     table: t1, rollup: t1
     preAggregation: on
     Predicates: [1: id, INT, true] IS NOT NULL
     dict_col=str_col,arr1
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13936
     actualRows=0, avgRowSize=39.0
     Pruned type: 15 <-> [ARRAY<INT>]
     cardinality: 2
     probe runtime filters:
     - filter_id = 0, probe_expr = (1: id)

PLAN FRAGMENT 2(F01)
  Fragment Cost: 4.0

  Input Partition: RANDOM
  OutPut Partition: BUCKET_SHUFFLE_HASH_PARTITIONED: 8: id
  OutPut Exchange Id: 02

  1:OlapScanNode
     table: t2, rollup: t2
     preAggregation: on
     Predicates: [8: id, INT, true] IS NOT NULL
     partitionsRatio=1/1, tabletsRatio=1/1
     tabletList=13942
     actualRows=0, avgRowSize=4.0
     cardinality: 2
-- !result
[UC]SELECT l.id, array_map(x -> concat(x, upper(l.str_col), lower(l.str_col)), l.arr1)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;
-- result:
1	["xAAAaaa","yAAAaaa"]
2	["xBBBbbb","yBBBbbb"]
-- !result
DROP TABLE t1;
-- result:
-- !result
DROP TABLE t2;
-- result:
-- !result