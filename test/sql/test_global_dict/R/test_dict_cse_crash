-- name: test_dict_cse_crash
SET cbo_enable_low_cardinality_optimize = true;
-- result:
-- !result
CREATE TABLE t1 (
    id INT,
    str_arr ARRAY<VARCHAR(100)> NOT NULL,
    arr2 ARRAY<VARCHAR(10)>
) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
CREATE TABLE t2 (id INT) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO t1 VALUES (1, ['aaa','bbb'], ['x','y']), (2, ['ccc','ddd'], ['z','w']);
-- result:
-- !result
INSERT INTO t2 VALUES (1), (2);
-- result:
-- !result
SELECT SLEEP(3);
-- result:
1
-- !result
[UC] ANALYZE FULL TABLE t1;
-- result:
-- !result
function: wait_global_dict_ready('str_arr', 't1')
-- result:

-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> concat(y, upper(x)), arr2), str_arr) FROM t1;
-- result:
-- !result
[UC]SELECT id, array_map(x -> array_map(y -> concat(y, upper(x)), arr2), str_arr) FROM t1 ORDER BY id;
-- result:
-- !result
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(x)), l.arr2), l.str_arr)
FROM t1 l JOIN t2 r ON l.id = r.id;
-- result:
-- !result
[UC]SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(x)), l.arr2), l.str_arr)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;
-- result:
-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> array_map(z -> concat(z, upper(x)), arr2), arr2), str_arr) FROM t1;
-- result:
-- !result
[UC]SELECT id, array_map(x -> array_map(y -> array_map(z -> concat(z, upper(x)), arr2), arr2), str_arr) FROM t1 ORDER BY id;
-- result:
-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> concat(y, upper(x), lower(x)), arr2), str_arr) FROM t1;
-- result:
-- !result
[UC]SELECT id, array_map(x -> array_map(y -> concat(y, upper(x), lower(x)), arr2), str_arr) FROM t1 ORDER BY id;
-- result:
-- !result
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> concat(y, upper(x), cast(length(x) as varchar)), arr2), str_arr) FROM t1;
-- result:
-- !result
[UC]SELECT id, array_map(x -> array_map(y -> concat(y, upper(x), cast(length(x) as varchar)), arr2), str_arr) FROM t1 ORDER BY id;
-- result:
-- !result
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(x), lower(x)), l.arr2), l.str_arr)
FROM t1 l JOIN t2 r ON l.id = r.id;
-- result:
-- !result
[UC]SELECT l.id, array_map(x -> array_map(y -> concat(y, upper(x), lower(x)), l.arr2), l.str_arr)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;
-- result:
-- !result
DROP TABLE t1;
-- result:
-- !result
DROP TABLE t2;
-- result:
-- !result
