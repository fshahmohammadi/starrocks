-- name: test_dict_cse_crash
SET cbo_enable_low_cardinality_optimize = true;
-- result:
-- !result
SET enable_scan_predicate_expr_reuse = false;
-- result:
-- !result
CREATE TABLE t1 (
    c VARCHAR(65535) NULL
) ENGINE=OLAP DUPLICATE KEY(c) DISTRIBUTED BY RANDOM PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO t1 VALUES ('A'), ('A');
-- result:
-- !result
SELECT SLEEP(3);
-- result:
1
-- !result
[UC] ANALYZE FULL TABLE t1;
-- result:
-- !result
function: wait_global_dict_ready('c', 't1')
-- result:

-- !result
WITH T2 AS (
    SELECT c IS NULL AS dict, ['A'] AS arr1, ['a'] AS arr2 FROM t1
),
T3 AS (
    SELECT ARRAY_LENGTH(ARRAY_MAP((arg1) -> ARRAY_SUM(ARRAY_MAP((arg2) -> dict, arr2)), arr1)) AS l FROM T2
)
SELECT * FROM T3 WHERE l > 10;
-- result:
-- !result
WITH T2 AS (
    SELECT upper(c) AS dict_upper, ['A'] AS arr1, ['a'] AS arr2 FROM t1
),
T3 AS (
    SELECT ARRAY_LENGTH(ARRAY_MAP((arg1) -> ARRAY_SUM(ARRAY_MAP((arg2) -> length(dict_upper), arr2)), arr1)) AS l FROM T2
)
SELECT * FROM T3 WHERE l > 10;
-- result:
-- !result
CREATE TABLE t2 (id INT) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO t2 VALUES (1), (2);
-- result:
-- !result
WITH T2 AS (
    SELECT c IS NULL AS dict, ['A'] AS arr1, ['a'] AS arr2, 1 as id FROM t1
),
T3 AS (
    SELECT ARRAY_LENGTH(ARRAY_MAP((arg1) -> ARRAY_SUM(ARRAY_MAP((arg2) -> dict, arr2)), arr1)) AS l, id FROM T2
)
SELECT * FROM T3 JOIN t2 ON T3.id = t2.id WHERE l > 10;
-- result:
-- !result
DROP TABLE t2;
-- result:
-- !result
WITH T2 AS (
    SELECT c IS NULL AS dict, ['A','B'] AS arr1, ['a','b'] AS arr2, ['x','y'] AS arr3 FROM t1
),
T3 AS (
    SELECT ARRAY_LENGTH(ARRAY_MAP((a1) -> ARRAY_SUM(ARRAY_MAP((a2) -> ARRAY_SUM(ARRAY_MAP((a3) -> dict, arr3)), arr2)), arr1)) AS l FROM T2
)
SELECT * FROM T3 WHERE l > 10;
-- result:
-- !result
SELECT ARRAY_LENGTH(ARRAY_MAP((arg1) -> ARRAY_SUM(ARRAY_MAP((arg2) -> c IS NULL, ['a'])), ['A'])) AS l
FROM t1
WHERE ARRAY_LENGTH(ARRAY_MAP((arg1) -> ARRAY_SUM(ARRAY_MAP((arg2) -> c IS NULL, ['a'])), ['A'])) > 10;
-- result:
-- !result
DROP TABLE t1;
-- result:
-- !result
