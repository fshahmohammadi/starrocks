-- name: test_dict_cse_crash
-- Test for crash when DictMappingExpr is in lambda's _common_sub_expr
-- Bug: expr_disable_open_rewrite uses children() instead of do_for_each_child()
--
-- Key pattern: TWO separate columns:
-- 1. str_col: dictified scalar VARCHAR column -> upper(str_col) becomes DictMappingExpr
-- 2. arr: array column for lambda iteration
-- Lambda: array_map(x -> concat(x, upper(str_col)), arr)
-- upper(str_col) doesn't depend on lambda arg x -> goes to lambda's _common_sub_expr
-- Result: DictMappingExpr in lambda's _common_sub_expr

SET cbo_enable_low_cardinality_optimize = true;

CREATE TABLE t1 (
    id INT,
    str_col VARCHAR(100) NOT NULL,
    arr ARRAY<VARCHAR(10)>
) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");

CREATE TABLE t2 (id INT) ENGINE=OLAP DUPLICATE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 1 PROPERTIES ("replication_num" = "1");

INSERT INTO t1 VALUES (1, 'aaa', ['x','y']), (2, 'bbb', ['z','w']);
INSERT INTO t2 VALUES (1), (2);

SELECT SLEEP(3);
[UC] ANALYZE FULL TABLE t1;
function: wait_global_dict_ready('str_col', 't1')

-- Test 1: Basic - upper(str_col) in lambda common sub-expr
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> concat(x, upper(str_col)), arr) FROM t1;

[UC]SELECT id, array_map(x -> concat(x, upper(str_col)), arr) FROM t1 ORDER BY id;

-- Test 2: With JOIN (triggers different code paths, runtime filters)
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> concat(x, upper(l.str_col)), l.arr)
FROM t1 l JOIN t2 r ON l.id = r.id;

[UC]SELECT l.id, array_map(x -> concat(x, upper(l.str_col)), l.arr)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;

-- Test 3: Multiple dict expressions in lambda common sub-expr
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> concat(x, upper(str_col), lower(str_col)), arr) FROM t1;

[UC]SELECT id, array_map(x -> concat(x, upper(str_col), lower(str_col)), arr) FROM t1 ORDER BY id;

-- Test 4: With hash function on dict column
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> concat(x, hex(murmur_hash3_32(str_col))), arr) FROM t1;

[UC]SELECT id, array_map(x -> concat(x, hex(murmur_hash3_32(str_col))), arr) FROM t1 ORDER BY id;

-- Test 5: Nested lambda with dict column in common sub-expr
[UC]EXPLAIN VERBOSE
SELECT id, array_map(x -> array_map(y -> concat(y, upper(str_col)), arr), arr) FROM t1;

[UC]SELECT id, array_map(x -> array_map(y -> concat(y, upper(str_col)), arr), arr) FROM t1 ORDER BY id;

-- Test 6: JOIN with multiple dict expressions
[UC]EXPLAIN VERBOSE
SELECT l.id, array_map(x -> concat(x, upper(l.str_col), lower(l.str_col)), l.arr)
FROM t1 l JOIN t2 r ON l.id = r.id;

[UC]SELECT l.id, array_map(x -> concat(x, upper(l.str_col), lower(l.str_col)), l.arr)
FROM t1 l JOIN t2 r ON l.id = r.id ORDER BY l.id;

DROP TABLE t1;
DROP TABLE t2;
