-- name: test_lambda_dict_hash_crash
-- Minimal reproduction for crash in _build_slices when hash function
-- accesses dict column inside lambda's _common_sub_expr
--
-- Root cause: expr_disable_open_rewrite uses children() instead of do_for_each_child()
-- Missing fix similar to PR #67843 for rewrite_expr

-- Enable dict optimization
SET cbo_enable_low_cardinality_optimize = true;

CREATE TABLE t_hash_crash (
    id INT,
    str_col VARCHAR(100) NOT NULL,
    arr ARRAY<VARCHAR(10)>
) ENGINE=OLAP
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id) BUCKETS 1
PROPERTIES ("replication_num" = "1");

INSERT INTO t_hash_crash VALUES
    (1, 'aaa', ['x', 'y']),
    (2, 'bbb', ['x', 'y']),
    (3, 'aaa', ['x', 'y']);

[UC] ANALYZE FULL TABLE t_hash_crash;
function: wait_global_dict_ready('str_col', 't_hash_crash')

-- This query should crash if the bug exists:
-- 1. str_col is dict-optimized
-- 2. murmur_hash3_32(str_col) doesn't depend on lambda arg 'x'
-- 3. Optimizer extracts it to _common_sub_expr
-- 4. expr_disable_open_rewrite misses the DictMappingExpr
-- 5. DictMappingExpr rewrites during open() but evaluates with binary data
-- 6. Hash function accesses invalid column state -> crash in _build_slices

SELECT id, array_map(x -> murmur_hash3_32(concat(x, str_col)), arr) FROM t_hash_crash ORDER BY id;

-- Alternative patterns that may trigger the same bug:
SELECT id, array_map(x -> xx_hash3_64(str_col), arr) FROM t_hash_crash ORDER BY id;
SELECT id, array_map(x -> concat(x, hex(murmur_hash3_32(str_col))), arr) FROM t_hash_crash ORDER BY id;

-- With JOIN to exercise RuntimeFilter path
CREATE TABLE t_hash_crash_right (
    id INT,
    val INT
) ENGINE=OLAP
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id) BUCKETS 1
PROPERTIES ("replication_num" = "1");

INSERT INTO t_hash_crash_right VALUES (1, 100), (2, 200);

-- RuntimeFilter + hash function on dict column
SELECT l.id, array_map(x -> murmur_hash3_32(concat(x, l.str_col)), l.arr) as result
FROM t_hash_crash l
JOIN t_hash_crash_right r ON l.id = r.id
ORDER BY l.id;

-- Multiple hash functions
SELECT l.id, array_map(x -> concat(hex(murmur_hash3_32(l.str_col)), hex(xx_hash3_64(l.str_col))), l.arr) as result
FROM t_hash_crash l
JOIN t_hash_crash_right r ON l.id = r.id
ORDER BY l.id;

DROP TABLE t_hash_crash_right;
DROP TABLE t_hash_crash;
